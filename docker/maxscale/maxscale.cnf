# ============================================
# MaxScale 설정 파일
# ============================================

[maxscale]
threads = auto
admin_host = 0.0.0.0
admin_port = 8989
admin_secure_gui = false

# ─────────────────────────────────────────────
# 서버 정의
# ─────────────────────────────────────────────
[master]
type = server
address = mariadb-master
port = 3306
protocol = MariaDBBackend

[slave]
type = server
address = mariadb-slave
port = 3306
protocol = MariaDBBackend

# ─────────────────────────────────────────────
# 모니터 (상태 감시 + 자동 Failover)
# ─────────────────────────────────────────────
[MariaDB-Monitor]
type = monitor
module = mariadbmon
servers = master,slave
user = maxscale_monitor
password = monitorpass
monitor_interval = 2000ms

# Failover 설정
auto_failover = true
auto_rejoin = true
enforce_read_only_slaves = true

# Failover 조건
failcount = 3
failover_timeout = 90s
switchover_timeout = 90s

# ─────────────────────────────────────────────
# Read/Write Split 서비스
# ─────────────────────────────────────────────
[Read-Write-Service]
type = service
router = readwritesplit
servers = master,slave
user = maxscale_user
password = maxscalepass

# 라우팅 옵션
master_failure_mode = fail_on_write
master_accept_reads = true

# 트랜잭션 기반 라우팅
transaction_replay = true
transaction_replay_max_size = 1Mi

# ─────────────────────────────────────────────
# 리스너 (클라이언트 연결 포트)
# ─────────────────────────────────────────────
[Read-Write-Listener]
type = listener
service = Read-Write-Service
protocol = MariaDBClient
port = 4006
